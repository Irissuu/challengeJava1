<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Motos</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <script defer th:src="@{/js/script.js}"></script>


</head>
<body th:with="page='motos'">
<div th:insert="fragments/header :: header"></div>


<main class="container">
    <div class="card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
            <h2 style="margin:0;">Motos</h2>
            <a id="btn-nova-moto" class="btn btn-primary" th:href="@{/motos/form}">Nova moto</a>
        </div>

        <table class="table" id="table-motos">
            <thead>
            <tr>
                <th>ID</th>
                <th>Placa</th>
                <th>Modelo</th>
                <th>Ano</th>
                <th data-col="acoes">Ações</th>
            </tr>
            </thead>
            <tbody id="tbody-motos"></tbody>
        </table>
    </div>
</main>

<div th:insert="fragments/footer :: footer"></div>

<script>
    function hasRole(me, roleName){
        const target = String(roleName).toUpperCase();
        const list = [];

        if (me) {
            if (me.role) list.push(String(me.role));
            if (me.perfil) list.push(String(me.perfil));
            if (me.papel) list.push(String(me.papel));
            if (me.funcao) list.push(String(me.funcao));
            if (Array.isArray(me.authorities)) {
                me.authorities.forEach(a => list.push(a?.authority ?? a));
            }
        }
        return list.map(s => String(s).toUpperCase())
            .some(s => s.includes(target));
    }

    function stripMotoActionsForNonManagers(){
        fetch("/usuarios/me", { credentials:"include", headers:{ "Accept":"application/json" }})
            .then(r => r.ok ? r.json() : Promise.reject(r.status))
            .then(me => {
                const isMotoManager = hasRole(me, "GERENCIA_MOTO");
                if (isMotoManager) return;

                document.getElementById("btn-nova-moto")?.remove();

                document.querySelector('#table-motos thead th[data-col="acoes"]')?.remove();

                const tbody = document.getElementById("tbody-motos");
                const stripRow = (tr) => {
                    if (!tr) return;
                    tr.querySelectorAll("a,button").forEach(el => {
                        const href = el.getAttribute("href") || "";
                        const act = (el.dataset.action || "").toLowerCase();
                        const isEdit = act.includes("edit") || act.includes("editar") || href.startsWith("/motos/form");
                        const isDelete = act.includes("exclu") || act.includes("delete") || href.includes("/motos/delete");
                        if (isEdit || isDelete) {
                            const cell = el.closest("td,th");
                            if (cell) cell.remove(); else el.remove();
                        }
                    });
                };

                Array.from(tbody.querySelectorAll("tr")).forEach(stripRow);

                const obs = new MutationObserver(recs => {
                    for (const rec of recs) {
                        rec.addedNodes.forEach(node => {
                            if (node.nodeType === 1 && node.tagName === "TR") stripRow(node);
                        });
                    }
                });
                obs.observe(tbody, { childList: true });
            })
            .catch(() => {  });
    }

    document.addEventListener("DOMContentLoaded", stripMotoActionsForNonManagers);
</script>

<script>document.addEventListener("DOMContentLoaded", loadMotos);</script>
</body>
</html>
